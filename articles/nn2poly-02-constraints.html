<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="nn2poly">
<title>02 - Constraining the weights in the NN • nn2poly</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="02 - Constraining the weights in the NN">
<meta property="og:description" content="nn2poly">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">nn2poly</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/nn2poly-01-introduction.html">01 - Introduction to nn2poly</a>
    <a class="dropdown-item" href="../articles/nn2poly-02-constraints.html">02 - Constraining the weights in the NN</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>02 - Constraining the weights in the NN</h1>
                        <h4 data-toc-skip class="author">Pablo
Morala</h4>
            
            <h4 data-toc-skip class="date">2023-06-20</h4>
      
      
      <div class="d-none name"><code>nn2poly-02-constraints.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="this-vignettes-goal">This vignette’s goal<a class="anchor" aria-label="anchor" href="#this-vignettes-goal"></a>
</h2>
<p>The goal of this vignette is to present how to impose the needed
constraints on the NN training so nn2poly can give accurate
approximations of the NN. Therefore, this is a replication of
<code><a href="../articles/nn2poly-01-introduction.html">vignette("nn2poly-01-introduction")</a></code> steps, but imposing
those constraints. Please refer to that introduction vignette to
understand nn2poly basics and expand on the details that will be omitted
here.</p>
<p>The initial setup will be the same, using <code>keras</code>and
<code>tensorflow</code> to create and train the NN. Additionally, we
will now use the auxiliary package <code>nn2poly.tools</code> that
implements some helper functions to impose the desired constraints on
the NN.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">nn2poly.tools</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ibidat.github.io/nn2poly/">nn2poly</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tensorflow.rstudio.com/" class="external-link">keras</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tensorflow" class="external-link">tensorflow</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># For reproducibility</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu">tensorflow</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/tensorflow/man/tf.html" class="external-link">tf</a></span><span class="op">$</span><span class="va">random</span><span class="op">$</span><span class="fu">set_seed</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>We will solve again two simple examples, regression and
classification.</p>
<div class="section level3">
<h3 id="simple-regression-example">Simple regression example<a class="anchor" aria-label="anchor" href="#simple-regression-example"></a>
</h3>
<div class="section level4">
<h4 id="simulated-data-generation">Simulated data generation<a class="anchor" aria-label="anchor" href="#simulated-data-generation"></a>
</h4>
<p>We will simulate polynomial data from the following polynomial: <span class="math inline">\(4x_1 - 3 x_2x_3\)</span>. Data will needs to be
scaled to the <span class="math inline">\([-1,1]\)</span> interval.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define the desired polynomial for the simulated data</span></span>
<span><span class="va">polynomial</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">polynomial</span><span class="op">$</span><span class="va">labels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">polynomial</span><span class="op">$</span><span class="va">values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>,<span class="op">-</span><span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define number of variables p and sample n</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fl">3</span></span>
<span><span class="va">n_sample</span> <span class="op">&lt;-</span> <span class="fl">500</span></span>
<span></span>
<span><span class="co"># Predictor variables</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>,<span class="va">n_sample</span>,<span class="va">p</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">p</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">X</span><span class="op">[</span>,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">n_sample</span>,<span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Response variable + small error term</span></span>
<span><span class="va">Y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="fu"><a href="../reference/eval_poly.html">eval_poly</a></span><span class="op">(</span><span class="va">X</span>,<span class="va">polynomial</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_sample</span>, <span class="fl">0</span>, <span class="fl">0.1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Store all as a data frame</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="co">#&gt;           V1          V2          V3         Y</span></span>
<span><span class="co">#&gt; 1 -0.6264538  0.07730312  1.13496509 -2.684020</span></span>
<span><span class="co">#&gt; 2  0.1836433 -0.29686864  1.11193185  1.632335</span></span>
<span><span class="co">#&gt; 3 -0.8356286 -1.18324224 -0.87077763 -6.344179</span></span>
<span><span class="co">#&gt; 4  1.5952808  0.01129269  0.21073159  6.279883</span></span>
<span><span class="co">#&gt; 5  0.3295078  0.99160104  0.06939565  1.165488</span></span>
<span><span class="co">#&gt; 6 -0.8204684  1.59396745 -1.66264885  4.650553</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Data scaling</span></span>
<span><span class="va">maxs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">data</span>, <span class="fl">2</span>, <span class="va">max</span><span class="op">)</span></span>
<span><span class="va">mins</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">data</span>, <span class="fl">2</span>, <span class="va">min</span><span class="op">)</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">data</span>, center <span class="op">=</span> <span class="va">mins</span> <span class="op">+</span> <span class="op">(</span><span class="va">maxs</span> <span class="op">-</span> <span class="va">mins</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span>, scale <span class="op">=</span> <span class="op">(</span><span class="va">maxs</span> <span class="op">-</span> <span class="va">mins</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Divide in train (0.75) and test (0.25)</span></span>
<span><span class="va">index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fl">0.75</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">train</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="va">index</span>, <span class="op">]</span></span>
<span><span class="va">test</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="op">-</span><span class="va">index</span>, <span class="op">]</span></span>
<span></span>
<span><span class="va">train_x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">train</span><span class="op">[</span>,<span class="op">-</span><span class="op">(</span><span class="va">p</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">train_y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">train</span><span class="op">[</span>,<span class="op">(</span><span class="va">p</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">test_x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">test</span><span class="op">[</span>,<span class="op">-</span><span class="op">(</span><span class="va">p</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">test_y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">test</span><span class="op">[</span>,<span class="op">(</span><span class="va">p</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="original-neural-network-with-constraints">Original neural network (with constraints)<a class="anchor" aria-label="anchor" href="#original-neural-network-with-constraints"></a>
</h3>
<p>In this case, we need to use the custom layers from
<code>nn2poly.tools</code> that include constraints. These constraints
are different from the usual constraints in <code>keras</code> because
in this case the restriction is applied to both the weight vector and
the bias at each neuron at the same time, while usual <code>keras</code>
constraints can only be employed on either the bias or the kernel
weights.</p>
<p>Here we will use the L1 norm, checking that each vector of weights +
bias arriving to a neuron satisfy that their L1 norm is equal or less
than 1. This is created using the function
<code>build_keras_model()</code> which requires: - The input dimension
<code>p</code>. - A list with the activation functions at each layer
<code>af_string_list</code>. - A list with the number of neurons at each
layer <code>h_neurons_vector</code>. - A list <code>my_max_norm</code>
consisting of two elements: the type of norm used (<code>l1_norm</code>
in this case) and the maximum value (1 in this case).</p>
<p>We can define all these parameters as well as the ones used by
<code>keras</code>:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># keras hyperparameters</span></span>
<span><span class="va">my_loss</span> <span class="op">&lt;-</span> <span class="st">"mse"</span></span>
<span><span class="va">my_metrics</span> <span class="op">&lt;-</span> <span class="st">"mse"</span></span>
<span><span class="va">my_optimizer</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/optimizer_adam.html" class="external-link">optimizer_adam</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">my_epochs</span> <span class="op">&lt;-</span> <span class="fl">2000</span></span>
<span><span class="va">my_validation_split</span> <span class="op">&lt;-</span> <span class="fl">0.2</span></span>
<span><span class="va">my_verbose</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span></span>
<span><span class="co"># Parameters:</span></span>
<span><span class="va">af_string_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"tanh"</span>, <span class="st">"tanh"</span>, <span class="st">"linear"</span><span class="op">)</span></span>
<span><span class="va">h_neurons_vector</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">50</span>, <span class="fl">50</span>, <span class="fl">1</span><span class="op">)</span> <span class="co"># If the output is linear, the last value should be 1</span></span>
<span><span class="va">my_max_norm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"l1_norm"</span>,<span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>Build the model with the custom constraints, then compile and fit the
model:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nn</span> <span class="op">&lt;-</span> <span class="fu">build_keras_model</span><span class="op">(</span><span class="va">p</span>,</span>
<span>    <span class="va">af_string_list</span>,</span>
<span>    <span class="va">h_neurons_vector</span>,</span>
<span>    <span class="va">my_max_norm</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compile the model</span></span>
<span><span class="fu"><a href="https://generics.r-lib.org/reference/compile.html" class="external-link">compile</a></span><span class="op">(</span><span class="va">nn</span>,</span>
<span>                loss <span class="op">=</span> <span class="va">my_loss</span>,</span>
<span>                optimizer <span class="op">=</span> <span class="va">my_optimizer</span>,</span>
<span>                metrics <span class="op">=</span> <span class="va">my_metrics</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Fit the model</span></span>
<span><span class="va">history</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span><span class="va">nn</span>,</span>
<span>                             <span class="va">train_x</span>,</span>
<span>                             <span class="va">train_y</span>,</span>
<span>                             verbose <span class="op">=</span> <span class="va">my_verbose</span>,</span>
<span>                             epochs <span class="op">=</span> <span class="va">my_epochs</span>,</span>
<span>                             validation_split <span class="op">=</span> <span class="va">my_validation_split</span>,</span>
<span>                             batch_size <span class="op">=</span> <span class="fl">50</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">nn</span></span>
<span><span class="co">#&gt; Model: "sequential_16"</span></span>
<span><span class="co">#&gt; __________________________________________________________________________________________________________________________</span></span>
<span><span class="co">#&gt;  Layer (type)                                         Output Shape                                     Param #            </span></span>
<span><span class="co">#&gt; ==========================================================================================================================</span></span>
<span><span class="co">#&gt;  layer__combined_l1_4 (Layer_Combined_L1)             (None, 50)                                       200                </span></span>
<span><span class="co">#&gt;  activation_4 (Activation)                            (None, 50)                                       0                  </span></span>
<span><span class="co">#&gt;  layer__combined_l1_5 (Layer_Combined_L1)             (None, 50)                                       2550               </span></span>
<span><span class="co">#&gt;  activation_5 (Activation)                            (None, 50)                                       0                  </span></span>
<span><span class="co">#&gt;  dense_20 (Dense)                                     (None, 1)                                        51                 </span></span>
<span><span class="co">#&gt; ==========================================================================================================================</span></span>
<span><span class="co">#&gt; Total params: 2,801</span></span>
<span><span class="co">#&gt; Trainable params: 2,801</span></span>
<span><span class="co">#&gt; Non-trainable params: 0</span></span>
<span><span class="co">#&gt; __________________________________________________________________________________________________________________________</span></span></code></pre></div>
<p>We can visualize the training process:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">history</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure/nn2poly-02-reg-history-1.png"></p>
<p>And we can also visualize the NN predictions vs the original Y
values.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Obtain the predicted values with the NN to compare them</span></span>
<span><span class="va">prediction_NN</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">nn</span>, <span class="va">test_x</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Diagonal plot implemented in the package to quickly visualize and compare predictions</span></span>
<span><span class="fu"><a href="../reference/plot_diagonal.html">plot_diagonal</a></span><span class="op">(</span>x_axis <span class="op">=</span>  <span class="va">prediction_NN</span>, y_axis <span class="op">=</span>  <span class="va">test_y</span>, xlab <span class="op">=</span> <span class="st">"NN prediction"</span>, ylab <span class="op">=</span> <span class="st">"Original Y"</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure/nn2poly-02-reg-comparison-y-nn-1.png"></p>
<div class="section level4">
<h4 id="using-nn2poly-to-obtain-the-polynomial">Using nn2poly to obtain the polynomial<a class="anchor" aria-label="anchor" href="#using-nn2poly-to-obtain-the-polynomial"></a>
</h4>
<p>After the NN has been trained (in this case with constraints) we
extract and reshape the weights and NN parameters as explained in
<code><a href="../articles/nn2poly-01-introduction.html">vignette("nn2poly-01-introduction")</a></code>, with the only
difference that the keras weights from the custom layers have a slightly
different behavior as they already include the bias in the weights
matrix:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">keras_weights</span> <span class="op">&lt;-</span> <span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/get_weights.html" class="external-link">get_weights</a></span><span class="op">(</span><span class="va">nn</span><span class="op">)</span></span>
<span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">keras_weights</span><span class="op">)</span></span>
<span></span>
<span><span class="va">nn_weights</span> <span class="op">&lt;-</span> <span class="va">keras_weights</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">n</span><span class="op">-</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Add last layer as this one has the bias separated, it is not a custom layer</span></span>
<span><span class="va">nn_weights</span><span class="op">[[</span><span class="va">n</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">keras_weights</span><span class="op">[[</span><span class="va">n</span><span class="op">]</span><span class="op">]</span>, <span class="va">keras_weights</span><span class="op">[[</span><span class="va">n</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p>The activation functions that we used can be stored as:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">af_string_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"tanh"</span>,<span class="st">"tanh"</span>, <span class="st">"linear"</span><span class="op">)</span></span></code></pre></div>
<p>And finally the order of the Taylor approximation that we are going
to choose is 8 at each hidden layer. (The final polynomial order will be
limited by <code>forced_max_Q=3</code>)</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">q_taylor_vector</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">8</span>, <span class="fl">8</span>,  <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>When the input is in the desired shape, the nn2poly method can be
applied:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">final_poly</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nn2poly_algorithm.html">nn2poly_algorithm</a></span><span class="op">(</span></span>
<span>  weights_list <span class="op">=</span> <span class="va">nn_weights</span>,</span>
<span>  af_string_list <span class="op">=</span> <span class="va">af_string_list</span>,</span>
<span>  q_taylor_vector <span class="op">=</span> <span class="va">q_taylor_vector</span>,</span>
<span>  store_coeffs <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  forced_max_Q <span class="op">=</span> <span class="fl">3</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="obtaining-polynomial-predictions">Obtaining polynomial predictions<a class="anchor" aria-label="anchor" href="#obtaining-polynomial-predictions"></a>
</h4>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Obtain the predicted values for the test data with our polynomial</span></span>
<span><span class="va">prediction_poly</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="fu"><a href="../reference/eval_poly.html">eval_poly</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">test_x</span>, poly <span class="op">=</span> <span class="va">final_poly</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="visualizing-the-results">Visualizing the results<a class="anchor" aria-label="anchor" href="#visualizing-the-results"></a>
</h4>
<ul>
<li>Diagonal plot. In this example, as we have imposed weight
constraints the approximation is better.</li>
</ul>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_diagonal.html">plot_diagonal</a></span><span class="op">(</span>x_axis <span class="op">=</span>  <span class="va">prediction_NN</span>, y_axis <span class="op">=</span>  <span class="va">prediction_poly</span>, xlab <span class="op">=</span> <span class="st">"NN prediction"</span>, ylab <span class="op">=</span> <span class="st">"Polynomial prediction"</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure/nn2poly-02-reg-comparison-polynomial-nn-1.png"></p>
<ul>
<li>Representing the activation potentials, it can be seen that now they
are centered around zero, where nn2poly works best.</li>
</ul>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_taylor_and_activation_potentials.html">plot_taylor_and_activation_potentials</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">train</span>,</span>
<span>                                    weights_list <span class="op">=</span> <span class="va">nn_weights</span>,</span>
<span>                                    af_string_list <span class="op">=</span> <span class="va">af_string_list</span>,</span>
<span>                                    q_taylor_vector <span class="op">=</span> <span class="va">q_taylor_vector</span>,</span>
<span>                                    forced_max_Q <span class="op">=</span> <span class="fl">3</span>,</span>
<span>                                    my_max_norm <span class="op">=</span> <span class="va">my_max_norm</span><span class="op">)</span></span>
<span><span class="co">#&gt; [[1]]</span></span></code></pre></div>
<p><img src="figure/nn2poly-02-reg-potentials-1.png"></p>
<pre><code><span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span></code></pre>
<p><img src="figure/nn2poly-02-reg-potentials-2.png"></p>
<pre><code><span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[3]]</span></span></code></pre>
<p><img src="figure/nn2poly-02-reg-potentials-3.png"></p>
</div>
</div>
<div class="section level3">
<h3 id="simple-classification-example">Simple classification example<a class="anchor" aria-label="anchor" href="#simple-classification-example"></a>
</h3>
<p>In this example, instead of a regression problem we will show a
classification example, where a NN will be trained to classify species
with the <code>iris</code> dataset, and then nn2poly will be employed to
obtain a polynomial for each species.</p>
<div class="section level4">
<h4 id="data-preparation">Data preparation<a class="anchor" aria-label="anchor" href="#data-preparation"></a>
</h4>
<p>We will load the <code>iris</code> and scale the data:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load the data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Change response to numeric. In this case, Species was already numeric,</span></span>
<span><span class="co"># but this step is needed if it is a factor variable.</span></span>
<span><span class="va">iris</span><span class="op">$</span><span class="va">Species</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">iris</span><span class="op">$</span><span class="va">Species</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define dimension p (number of predictor variables)</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span></span>
<span></span>
<span><span class="co"># Define objective classes</span></span>
<span><span class="va">n_class</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">iris</span><span class="op">[</span>,<span class="op">(</span><span class="va">p</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Move objective classes from (1:3) to (0:2), needed for tensorflow</span></span>
<span><span class="va">iris</span><span class="op">[</span>,<span class="op">(</span><span class="va">p</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">iris</span><span class="op">[</span>,<span class="op">(</span><span class="va">p</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span></span></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Scale the data in the [-1,1] interval and separate train and test</span></span>
<span><span class="co"># Only the predictor variables are scaled, not the response as those will be</span></span>
<span><span class="co"># the different classes.</span></span>
<span><span class="va">iris_x</span> <span class="op">&lt;-</span> <span class="va">iris</span><span class="op">[</span>,<span class="op">-</span><span class="op">(</span><span class="va">p</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">maxs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">iris_x</span>, <span class="fl">2</span>, <span class="va">max</span><span class="op">)</span></span>
<span><span class="va">mins</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">iris_x</span>, <span class="fl">2</span>, <span class="va">min</span><span class="op">)</span></span>
<span><span class="va">data_x_scaled</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">iris_x</span>, center <span class="op">=</span> <span class="va">mins</span> <span class="op">+</span> <span class="op">(</span><span class="va">maxs</span> <span class="op">-</span> <span class="va">mins</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span>, scale <span class="op">=</span> <span class="op">(</span><span class="va">maxs</span> <span class="op">-</span> <span class="va">mins</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">data_x_scaled</span>, <span class="va">iris</span><span class="op">[</span>,<span class="op">(</span><span class="va">p</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Divide in train (0.75) and test (0.25)</span></span>
<span><span class="va">index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fl">0.75</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">train</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="va">index</span>, <span class="op">]</span></span>
<span><span class="va">test</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="op">-</span><span class="va">index</span>, <span class="op">]</span></span>
<span></span>
<span><span class="va">train_x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">train</span><span class="op">[</span>,<span class="op">-</span><span class="op">(</span><span class="va">p</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">train_y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">train</span><span class="op">[</span>,<span class="op">(</span><span class="va">p</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">test_x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">test</span><span class="op">[</span>,<span class="op">-</span><span class="op">(</span><span class="va">p</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">test_y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">test</span><span class="op">[</span>,<span class="op">(</span><span class="va">p</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="original-neural-network">Original neural network<a class="anchor" aria-label="anchor" href="#original-neural-network"></a>
</h4>
<p>We can now train the NN, following the same procedure as in the
regression problem and using the <code>build_keras_model</code> function
which includes the layers with custom constrains.</p>
<p>First we define the parameters and keras hyperparameters:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># keras hyperparameters</span></span>
<span><span class="va">my_loss</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/loss-functions.html" class="external-link">loss_sparse_categorical_crossentropy</a></span><span class="op">(</span>from_logits <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">my_metrics</span> <span class="op">&lt;-</span> <span class="st">"accuracy"</span></span>
<span><span class="va">my_optimizer</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/optimizer_adam.html" class="external-link">optimizer_adam</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">my_epochs</span> <span class="op">&lt;-</span> <span class="fl">500</span></span>
<span><span class="va">my_validation_split</span> <span class="op">&lt;-</span> <span class="fl">0.2</span></span>
<span><span class="va">my_verbose</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span></span>
<span><span class="co"># Parameters:</span></span>
<span><span class="va">af_string_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"tanh"</span>, <span class="st">"tanh"</span>, <span class="st">"linear"</span><span class="op">)</span></span>
<span><span class="va">h_neurons_vector</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">50</span>, <span class="fl">50</span>, <span class="va">n_class</span><span class="op">)</span></span>
<span><span class="va">my_max_norm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"l1_norm"</span>,<span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>Build the model with the custom constraints, then compile and fit the
model:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nn</span> <span class="op">&lt;-</span> <span class="fu">build_keras_model</span><span class="op">(</span><span class="va">p</span>,</span>
<span>    <span class="va">af_string_list</span>,</span>
<span>    <span class="va">h_neurons_vector</span>,</span>
<span>    <span class="va">my_max_norm</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compile the model</span></span>
<span><span class="fu"><a href="https://generics.r-lib.org/reference/compile.html" class="external-link">compile</a></span><span class="op">(</span><span class="va">nn</span>,</span>
<span>                loss <span class="op">=</span> <span class="va">my_loss</span>,</span>
<span>                optimizer <span class="op">=</span> <span class="va">my_optimizer</span>,</span>
<span>                metrics <span class="op">=</span> <span class="va">my_metrics</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Fit the model</span></span>
<span><span class="va">history</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span><span class="va">nn</span>,</span>
<span>                             <span class="va">train_x</span>,</span>
<span>                             <span class="va">train_y</span>,</span>
<span>                             verbose <span class="op">=</span> <span class="va">my_verbose</span>,</span>
<span>                             epochs <span class="op">=</span> <span class="va">my_epochs</span>,</span>
<span>                             validation_split <span class="op">=</span> <span class="va">my_validation_split</span>,</span>
<span>                             batch_size <span class="op">=</span> <span class="fl">50</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">nn</span></span>
<span><span class="co">#&gt; Model: "sequential_17"</span></span>
<span><span class="co">#&gt; __________________________________________________________________________________________________________________________</span></span>
<span><span class="co">#&gt;  Layer (type)                                         Output Shape                                     Param #            </span></span>
<span><span class="co">#&gt; ==========================================================================================================================</span></span>
<span><span class="co">#&gt;  layer__combined_l1_6 (Layer_Combined_L1)             (None, 50)                                       250                </span></span>
<span><span class="co">#&gt;  activation_6 (Activation)                            (None, 50)                                       0                  </span></span>
<span><span class="co">#&gt;  layer__combined_l1_7 (Layer_Combined_L1)             (None, 50)                                       2550               </span></span>
<span><span class="co">#&gt;  activation_7 (Activation)                            (None, 50)                                       0                  </span></span>
<span><span class="co">#&gt;  dense_21 (Dense)                                     (None, 3)                                        153                </span></span>
<span><span class="co">#&gt; ==========================================================================================================================</span></span>
<span><span class="co">#&gt; Total params: 2,953</span></span>
<span><span class="co">#&gt; Trainable params: 2,953</span></span>
<span><span class="co">#&gt; Non-trainable params: 0</span></span>
<span><span class="co">#&gt; __________________________________________________________________________________________________________________________</span></span></code></pre></div>
<p>We can visualize the training process:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">history</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure/nn2poly-02-class-history-1.png"></p>
<p>In this case, to asses the NN accuracy we have to transform the nn
output into a probability:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">probability_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/keras_model_sequential.html" class="external-link">keras_model_sequential</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">nn</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_activation_softmax.html" class="external-link">layer_activation_softmax</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_lambda.html" class="external-link">layer_lambda</a></span><span class="op">(</span><span class="va">k_argmax</span><span class="op">)</span></span></code></pre></div>
<p>And predict the results for the test data:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Obtain the predicted classes with the NN to compare them</span></span>
<span><span class="va">prediction_NN_class</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">probability_model</span>, <span class="va">test_x</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Also, the linear output can be predicted before the probability model</span></span>
<span><span class="va">prediction_NN</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">nn</span>, <span class="va">test_x</span><span class="op">)</span></span></code></pre></div>
<p>We can use here a confusion matrix to visualize the results, where we
can see that the NN correctly predicts the classes of each
observation:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create a confusion matrix</span></span>
<span><span class="va">cm</span> <span class="op">&lt;-</span> <span class="fu">caret</span><span class="fu">::</span><span class="fu">confusionMatrix</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">prediction_NN_class</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">test_y</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">cm</span></span>
<span><span class="co">#&gt; Confusion Matrix and Statistics</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;           Reference</span></span>
<span><span class="co">#&gt; Prediction  0  1  2</span></span>
<span><span class="co">#&gt;          0 15  0  0</span></span>
<span><span class="co">#&gt;          1  0 11  0</span></span>
<span><span class="co">#&gt;          2  0  0 12</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Overall Statistics</span></span>
<span><span class="co">#&gt;                                      </span></span>
<span><span class="co">#&gt;                Accuracy : 1          </span></span>
<span><span class="co">#&gt;                  95% CI : (0.9075, 1)</span></span>
<span><span class="co">#&gt;     No Information Rate : 0.3947     </span></span>
<span><span class="co">#&gt;     P-Value [Acc &gt; NIR] : 4.568e-16  </span></span>
<span><span class="co">#&gt;                                      </span></span>
<span><span class="co">#&gt;                   Kappa : 1          </span></span>
<span><span class="co">#&gt;                                      </span></span>
<span><span class="co">#&gt;  Mcnemar's Test P-Value : NA         </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Statistics by Class:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                      Class: 0 Class: 1 Class: 2</span></span>
<span><span class="co">#&gt; Sensitivity            1.0000   1.0000   1.0000</span></span>
<span><span class="co">#&gt; Specificity            1.0000   1.0000   1.0000</span></span>
<span><span class="co">#&gt; Pos Pred Value         1.0000   1.0000   1.0000</span></span>
<span><span class="co">#&gt; Neg Pred Value         1.0000   1.0000   1.0000</span></span>
<span><span class="co">#&gt; Prevalence             0.3947   0.2895   0.3158</span></span>
<span><span class="co">#&gt; Detection Rate         0.3947   0.2895   0.3158</span></span>
<span><span class="co">#&gt; Detection Prevalence   0.3947   0.2895   0.3158</span></span>
<span><span class="co">#&gt; Balanced Accuracy      1.0000   1.0000   1.0000</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="using-nn2poly-to-obtain-the-polynomial-1">Using nn2poly to obtain the polynomial<a class="anchor" aria-label="anchor" href="#using-nn2poly-to-obtain-the-polynomial-1"></a>
</h4>
<p>After the NN has been trained, we need to extract and reshape the
parameters as explained in the regression case:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">keras_weights</span> <span class="op">&lt;-</span> <span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/get_weights.html" class="external-link">get_weights</a></span><span class="op">(</span><span class="va">nn</span><span class="op">)</span></span>
<span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">keras_weights</span><span class="op">)</span></span>
<span></span>
<span><span class="va">nn_weights</span> <span class="op">&lt;-</span> <span class="va">keras_weights</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">n</span><span class="op">-</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Add last layer as this one has the bias separated, it is not a custom layer</span></span>
<span><span class="va">nn_weights</span><span class="op">[[</span><span class="va">n</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">keras_weights</span><span class="op">[[</span><span class="va">n</span><span class="op">]</span><span class="op">]</span>, <span class="va">keras_weights</span><span class="op">[[</span><span class="va">n</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p>The activation functions that we used can be stored as:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">af_string_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"tanh"</span>,<span class="st">"tanh"</span>, <span class="st">"linear"</span><span class="op">)</span></span></code></pre></div>
<p>And finally the order of the Taylor approximation that we are going
to choose is 8 at each hidden layer. (The final polynomial order will be
limited by <code>forced_max_Q=3</code>)</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">q_taylor_vector</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">8</span>, <span class="fl">8</span>,  <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>When the input is in the desired shape, the nn2poly method can be
applied:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">final_poly</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nn2poly_algorithm.html">nn2poly_algorithm</a></span><span class="op">(</span></span>
<span>  weights_list <span class="op">=</span> <span class="va">nn_weights</span>,</span>
<span>  af_string_list <span class="op">=</span> <span class="va">af_string_list</span>,</span>
<span>  q_taylor_vector <span class="op">=</span> <span class="va">q_taylor_vector</span>,</span>
<span>  store_coeffs <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  forced_max_Q <span class="op">=</span> <span class="fl">3</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="obtaining-polynomial-predictions-1">Obtaining polynomial predictions<a class="anchor" aria-label="anchor" href="#obtaining-polynomial-predictions-1"></a>
</h4>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Obtain the predicted values for the test data with our Polynomial Regression</span></span>
<span><span class="va">prediction_poly_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/eval_poly.html">eval_poly</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">test_x</span>, poly <span class="op">=</span> <span class="va">final_poly</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define probability model with keras fro the polynomial outputs</span></span>
<span><span class="va">probability_poly</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/keras_model_sequential.html" class="external-link">keras_model_sequential</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_activation_softmax.html" class="external-link">layer_activation_softmax</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_lambda.html" class="external-link">layer_lambda</a></span><span class="op">(</span><span class="va">k_argmax</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Class prediction with the polynomial outputs (one row for each polynomial)</span></span>
<span><span class="va">prediction_poly_class</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">probability_poly</span>,<span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">prediction_poly_matrix</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="visualising-the-results">Visualising the results<a class="anchor" aria-label="anchor" href="#visualising-the-results"></a>
</h4>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Confussion matrix between NN class prediction and polynomial class prediction</span></span>
<span><span class="va">cm</span> <span class="op">&lt;-</span> <span class="fu">caret</span><span class="fu">::</span><span class="fu">confusionMatrix</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">prediction_NN_class</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">prediction_poly_class</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">cm</span></span>
<span><span class="co">#&gt; Confusion Matrix and Statistics</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;           Reference</span></span>
<span><span class="co">#&gt; Prediction  0  1  2</span></span>
<span><span class="co">#&gt;          0 15  0  0</span></span>
<span><span class="co">#&gt;          1  0 11  0</span></span>
<span><span class="co">#&gt;          2  0  0 12</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Overall Statistics</span></span>
<span><span class="co">#&gt;                                      </span></span>
<span><span class="co">#&gt;                Accuracy : 1          </span></span>
<span><span class="co">#&gt;                  95% CI : (0.9075, 1)</span></span>
<span><span class="co">#&gt;     No Information Rate : 0.3947     </span></span>
<span><span class="co">#&gt;     P-Value [Acc &gt; NIR] : 4.568e-16  </span></span>
<span><span class="co">#&gt;                                      </span></span>
<span><span class="co">#&gt;                   Kappa : 1          </span></span>
<span><span class="co">#&gt;                                      </span></span>
<span><span class="co">#&gt;  Mcnemar's Test P-Value : NA         </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Statistics by Class:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                      Class: 0 Class: 1 Class: 2</span></span>
<span><span class="co">#&gt; Sensitivity            1.0000   1.0000   1.0000</span></span>
<span><span class="co">#&gt; Specificity            1.0000   1.0000   1.0000</span></span>
<span><span class="co">#&gt; Pos Pred Value         1.0000   1.0000   1.0000</span></span>
<span><span class="co">#&gt; Neg Pred Value         1.0000   1.0000   1.0000</span></span>
<span><span class="co">#&gt; Prevalence             0.3947   0.2895   0.3158</span></span>
<span><span class="co">#&gt; Detection Rate         0.3947   0.2895   0.3158</span></span>
<span><span class="co">#&gt; Detection Prevalence   0.3947   0.2895   0.3158</span></span>
<span><span class="co">#&gt; Balanced Accuracy      1.0000   1.0000   1.0000</span></span></code></pre></div>
<p>We can compare, for each polynomial, its output with the the linear
output of the NN. In this case, as constraints have been used in
training, the results are much closer than what happened in
<code><a href="../articles/nn2poly-01-introduction.html">vignette("nn2poly-01-introduction")</a></code></p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/plot_diagonal.html">plot_diagonal</a></span><span class="op">(</span>x_axis <span class="op">=</span>  <span class="va">prediction_NN</span><span class="op">[</span>,<span class="va">i</span><span class="op">]</span>,</span>
<span>                  y_axis <span class="op">=</span>  <span class="va">prediction_poly_matrix</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span>,</span>
<span>                  xlab <span class="op">=</span> <span class="st">"NN prediction"</span>,</span>
<span>                  ylab <span class="op">=</span> <span class="st">"Polynomial prediction"</span><span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="figure/nn2poly-02-class-diagonal-plot-1.png"><img src="figure/nn2poly-02-class-diagonal-plot-2.png"><img src="figure/nn2poly-02-class-diagonal-plot-3.png"></p>
<p>Finally, activation potentials can be visualized as follows, where it
can be seen that the constraints have made the activations to be closer
to zero than in the unrestricted case. However, there is still some
dispersion in them that creates the slight deviations seen in the
diagonal plots. However, the</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_taylor_and_activation_potentials.html">plot_taylor_and_activation_potentials</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">train</span>,</span>
<span>                                    weights_list <span class="op">=</span> <span class="va">nn_weights</span>,</span>
<span>                                    af_string_list <span class="op">=</span> <span class="va">af_string_list</span>,</span>
<span>                                    q_taylor_vector <span class="op">=</span> <span class="va">q_taylor_vector</span>,</span>
<span>                                    forced_max_Q <span class="op">=</span> <span class="fl">3</span>,</span>
<span>                                    my_max_norm <span class="op">=</span> <span class="va">my_max_norm</span><span class="op">)</span></span>
<span><span class="co">#&gt; [[1]]</span></span></code></pre></div>
<p><img src="figure/nn2poly-02-potentials-1.png"></p>
<pre><code><span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span></code></pre>
<p><img src="figure/nn2poly-02-potentials-2.png"></p>
<pre><code><span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[3]]</span></span></code></pre>
<p><img src="figure/nn2poly-02-potentials-3.png"></p>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Pablo Morala, Iñaki Ucar.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
